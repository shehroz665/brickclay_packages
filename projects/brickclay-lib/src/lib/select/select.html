<div class="ng-select-container">

  <label
    class="input-label"
    (click)="openFromLabel($event)">
    {{ label }}
    @if(required){
      <span class="input-label-required">*</span>
    }
  </label>

  <div
    #controlWrapper
    class="ng-select-control"
    [class.focused]="isOpen()"
    [class.disabled]="disabled()"
    (mousedown)="toggleDropdown($event)"
  >
    <!-- Icon (Always visible if set) -->
    @if(iconSrc){
      <img [src]="iconSrc" [alt]="iconAlt" class="shrink-0" />
    }
    <div class="ng-value-container">
      @if (selectedOptions().length === 0)
      {
         <div class="ng-placeholder">{{ placeholder() }}</div>
        }
      @if
      (multiple() && selectedOptions().length > 0) {
        <div class="ng-value-chips">
          @for (opt of selectedOptions().slice(0, maxLabels()); track $index) {
            <div class="ng-value-chip">
              <span class="ng-value-label">{{ resolveLabel(opt) }}</span>
              <span class="ng-value-icon" (mousedown)="removeOption(opt, $event)">Ã—</span>
            </div>
          }
          @if (selectedOptions().length > maxLabels()) {
            <div class="ng-value-chip remaining-count"><span class="ng-value-label">+{{ selectedOptions().length - maxLabels() }} more</span></div>
          }
        </div>
      }
      @if (!multiple() && selectedOptions().length > 0) {
        <div class="ng-value-label-single">{{ resolveLabel(selectedOptions()[0]) }}</div>
      }
    </div>
    <div class="ng-actions">
      @if (clearable() && selectedOptions().length > 0 && !disabled()) {
        <span class="ng-clear-wrapper" (mousedown)="handleClear($event)" title="Clear">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </span>
      }
      <span class="ng-arrow-wrapper" [class.open]="isOpen()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
      </span>
    </div>
  </div>

  @if (isOpen()) {
    <div
      #dropdownPanel
      class="custom-ng-dropdown-panel"
      [attr.data-position]="dropdownPosition()"
      (scroll)="onScroll($event)"

      [style.position]="appendToBody() ? 'fixed' : 'absolute'"
      [style.top]="getTop()"
      [style.bottom]="getBottom()"
      [style.left]="appendToBody() ? dropdownStyle().left : null"
      [style.width]="appendToBody() ? dropdownStyle().width : '100%'"
    >


    @if (searchable()) {
        <div class="ng-dropdown-search">
          <div class="ng-search-wrapper">
            <svg class="text-[#BBBDC5] mr-2" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input #searchInput type="text" class="ng-search-input" [value]="searchTerm()" [placeholder]="'Search...'" (input)="onSearchInput($event)" (keydown)="onKeyDown($event)" (click)="$event.stopPropagation()">
          </div>
        </div>
      }
      @if (multiple() && filteredItems().length > 0) {
        <div class="ng-option select-all-option" (mousedown)="toggleSelectAll($event)">
          <div class="mr-2 flex items-center justify-center w-4 h-4 border border-gray-300 rounded bg-white" [class.bg-blue-600]="isAllSelected()" [class.border-blue-600]="isAllSelected()">
            @if(isAllSelected()){ <svg class="text-white w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg> }
          </div>
          <span class="font-semibold">Select All</span>
        </div>
      }
      <div #optionsListContainer class="ng-options-list">
        @if (loading()) { <div class="ng-option-disabled">{{ loadingText() }}</div> }
        @else {
          @for (item of filteredItems(); track $index) {
            <div #optionsRef class="ng-option" [class.selected]="isItemSelected(item)" [class.marked]="$index === markedIndex()" (click)="handleSelection(item, $event)" (click)="markedIndex.set($index)">
              @if (multiple()) {
                <div class="mr-2 flex items-center justify-center w-4 h-4 border border-gray-300 rounded bg-white" [class.bg-blue-600]="isItemSelected(item)" [class.border-blue-600]="isItemSelected(item)">
                  @if(isItemSelected(item)){ <svg class="text-white w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg> }
                </div>
              }
              <span class="flex-1">{{ resolveLabel(item) }}</span>
              @if (!multiple() && isItemSelected(item)) {
                <svg class="text-[#141414]" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
              }
            </div>
          }
          @if (filteredItems().length === 0) { <div class="ng-option-disabled">{{ notFoundText() }}</div> }
        }
      </div>

    </div>
  }
</div>
